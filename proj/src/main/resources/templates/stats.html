<!-- src/main/resources/templates/home.html -->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>MySQL Data Graph</title>
	<!-- Add your chart library or use CDN here (e.g., Chart.js) -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
	<h1>MySQL Data Graph</h1>

	<!-- Date range selection -->
	<label for="startDate">Start Date:</label>
	<input type="date" id="startDate" name="startDate">

	<label for="endDate">End Date:</label>
	<input type="date" id="endDate" name="endDate">

	<button onclick="updateChart()">Update Chart</button>

	<canvas id="myChart" width="400" height="200"></canvas>

	<script th:inline="javascript">
		/*<![CDATA[*/

		// Extracting data from Thymeleaf model attribute
		var originalData = /*[[${data}]]*/[];
		var data = originalData.slice(); // Create a copy to preserve original data

		// Function to convert date strings to JavaScript Date objects
		function convertDates(data) {
			return data.map(function (row) {
				// Assuming your_label_column_name is the column containing date in 'YYYYMMDD' format
				var dateString = row['date'];

				// Extracting year, month, and day from the string
				var year = parseInt(dateString.substring(0, 4), 10);
				var month = parseInt(dateString.substring(4, 6), 10) - 1; // Month is 0-based in JavaScript Date
				var day = parseInt(dateString.substring(6, 8), 10) + 1;
				
				

				// Creating a JavaScript Date object
				row['date'] = new Date(year, month, day);
				return row;
			});
		}

		// Function to update the chart based on date range
		function updateChart() {
			var startDateString = document.getElementById("startDate").value;
			var endDateString = document.getElementById("endDate").value;
			// Log the selected date range to the console
			console.log("Start Date:", startDateString);
			console.log("End Date:", endDateString);

			var startDate = new Date(startDateString);
			var endDate = new Date(endDateString);

			// Filter data within the specified date range
			data = originalData.filter(function (row) {
				// Assuming your_label_column_name is the column containing date in 'YYYYMMDD' format
				var date = row['date'];


				if (!(date instanceof Date)) {
					parseInt(row['date'].substring(0, 4), 10),
						parseInt(row['date'].substring(4, 6), 10) - 1,
						parseInt(row['date'].substring(6, 8), 10)

					row['date'] = new Date(year, month, day);
				}

				return date >= startDate && date <= endDate;
			});

			// Sort data in ascending order by date
			data.sort(function (a, b) {
				return a['date'] - b['date'];
			});
			if (window.myChart) {
				window.myChart.destroy();
			}
			// Update the chart
			updateChartWithData();
		}

		// Function to extract labels and values and draw the chart
		function updateChartWithData() {
			var labels = data.map(function (row) {
				// Format date as 'YYYY-MM-DD'
				return row['date'].toISOString().split('T')[0];
			});

			var values = data.map(function (row) {
				return row['cnt'];
			});

			// Drawing a line chart using Chart.js
			var ctx = document.getElementById('myChart').getContext('2d');
			// Destroy existing chart if it exists

			window.myChart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: labels,
					datasets: [{
						label: 'Your Chart Label',
						data: values,
						borderWidth: 1
					}]
				},
				options: {

					// Add your chart options here
				}
			});
		}

		// Initial chart drawing
		data = convertDates(data);
		data.sort(function (a, b) {
			return a['date'] - b['date'];
		});
		updateChartWithData();

		/*]]>*/
	</script>
</body>

</html>